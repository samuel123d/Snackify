<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SNACKIFY</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
<style>
body, html { margin:0; padding:0; height:100%; display:flex; flex-direction:column; }
main { flex:1 0 auto; padding-bottom:100px; }
footer { flex-shrink:0; background:#fff; border-top:1px solid #e6e6ee; padding:18px 0; position:fixed; bottom:0; left:0; right:0; z-index:1000; }
.product-card { position:relative; cursor:pointer; }
.edit-btn { position:absolute; top:5px; right:5px; display:flex; gap:5px; }

/* Estilos para as imagens dos produtos e placeholders */
.product-image { width: 100%; height: 150px; object-fit: cover; border-bottom: 1px solid #eee; }
.product-image-placeholder {
  width: 100%;
  height: 150px;
  background-color: #f8f9fa; /* cor de fundo para o placeholder */
  border-bottom: 1px solid #eee;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 3rem; /* Tamanho do √≠cone */
  color: #6c757d; /* Cor do √≠cone */
}
.product-image-placeholder.salgadinho { background-color: #ffeeba; } /* Amarelo claro para salgadinho */
.product-image-placeholder.bebida { background-color: #add8e6; } /* Azul claro para bebida */
</style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom">
  <div class="container">
    <a class="navbar-brand fw-bold" href="#">SNACKIFY</a>
    <div class="d-flex align-items-center">
      <span id="loginStatus" class="me-3 text-muted"></span>
      <button id="loginLogoutBtn" class="btn btn-outline-primary btn-sm me-2">Login</button>
      <button id="cartButton" class="btn btn-success btn-sm position-relative">
        <i class="bi bi-cart"></i>
        <span id="cartBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">0</span>
      </button>
    </div>
  </div>
</nav>

<header class="py-5 text-center">
  <div class="container">
    <h1 class="display-6">Pe√ßa seus snacks e bebidas pelo WhatsApp</h1>
    <p class="text-muted mt-2">Cheetos, Ruffles, Doritos, Fandangos, Kr√≥, Coca-Cola, Fanta, Guaran√°, Sprite e muito mais.</p>
    <button id="addProductBtn" class="btn btn-success btn-sm d-none">+ Adicionar Produto</button>
  </div>
</header>

<main class="container mb-5">
  <section class="mb-5">
    <h2 class="h4 mb-3">Salgadinhos</h2>
    <div id="salgadinhosGrid" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-3">
      </div>
  </section>
  <section>
    <h2 class="h4 mb-3">Bebidas</h2>
    <div id="bebidasGrid" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-3"></div>
  </section>
</main>

<div class="modal fade" id="productModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Adicionar/Editar Produto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="productForm">
          <input type="hidden" id="productId">
          <div class="mb-3">
            <label for="productName" class="form-label">Nome</label>
            <input type="text" class="form-control" id="productName" required>
          </div>
          <div class="mb-3">
            <label for="productPrice" class="form-label">Pre√ßo</label>
            <input type="number" class="form-control" id="productPrice" required>
          </div>
          <div class="mb-3">
            <label for="productCategory" class="form-label">Categoria</label>
            <select class="form-select" id="productCategory" multiple required>
              <option value="Salgadinho">Salgadinho</option>
              <option value="Bebida">Bebida</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="productSizes" class="form-label">Tamanhos (P,M,G)</label>
            <input type="text" class="form-control" id="productSizes" value="P,M,G" required>
          </div>
          <div class="mb-3">
            <label for="productImage" class="form-label">URL da Imagem (Opcional)</label>
            <input type="url" class="form-control" id="productImage">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="saveProductBtn">Salvar</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="loginModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Login</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="form-floating mb-3">
          <input type="email" class="form-control" id="loginEmail" placeholder="email@example.com" />
          <label for="loginEmail">Email</label>
        </div>
        <div class="form-floating mb-3">
          <input type="password" class="form-control" id="loginPassword" placeholder="Senha" />
          <label for="loginPassword">Senha</label>
        </div>
        <div id="loginAlert" style="display:none;"></div>
        <button class="btn btn-primary w-100 mt-2" id="loginSubmitBtn">Entrar</button>
      </div>
    </div>
  </div>
</div>

<div class="offcanvas offcanvas-end" tabindex="-1" id="cartOffcanvas">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">Carrinho</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body d-flex flex-column">
    <div id="cartItems" class="list-group mb-3"></div>
    <div class="mt-auto">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <strong>Total</strong>
        <strong id="cartTotal">R$ 0,00</strong>
      </div>
      <div class="d-grid gap-2">
        <button id="clearCartBtn" class="btn btn-outline-secondary">Limpar carrinho</button>
        <button id="checkoutBtn" class="btn btn-success">Finalizar compra</button>
      </div>
    </div>
  </div>
</div>

<footer>
  <div class="container d-flex justify-content-between align-items-center">
    <small class="text-muted">SNACKIFY ‚Ä¢ Pe√ßa direto pelo WhatsApp</small>
    <a id="quickWhatsBtn" class="btn btn-success btn-sm" href="#" target="_blank">WhatsApp</a>
  </div>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDmmt1wbET6-dcvdsBGXW9j8Pm-S9N4kcs",
  authDomain: "lerning-project-4762d.firebaseapp.com",
  projectId: "lerning-project-4762d",
  storageBucket: "lerning-project-4762d.appspot.com",
  messagingSenderId: "45818309485",
  appId: "1:45818309485:web:e5ef5b9532c6e7d2754864",
  measurementId: "G-6HR53JJSW4"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let isLoggedIn = false;
let currentUserId = null;
let cart = [];

const loginStatus = document.getElementById("loginStatus");
const loginLogoutBtn = document.getElementById("loginLogoutBtn");
const addProductBtn = document.getElementById("addProductBtn");
const cartButton = document.getElementById("cartButton");
const cartBadge = document.getElementById("cartBadge");
const cartOffcanvas = new bootstrap.Offcanvas(document.getElementById("cartOffcanvas"));
const loginModal = new bootstrap.Modal(document.getElementById("loginModal"));
const productModal = new bootstrap.Modal(document.getElementById("productModal"));

const loginEmail = document.getElementById("loginEmail");
const loginPassword = document.getElementById("loginPassword");
const loginSubmitBtn = document.getElementById("loginSubmitBtn");
const loginAlert = document.getElementById("loginAlert");

const salgadinhosGrid = document.getElementById("salgadinhosGrid");
const bebidasGrid = document.getElementById("bebidasGrid");


// --- Fun√ß√µes Auxiliares ---

function showLoginAlert(msg, type="danger"){
  loginAlert.style.display="block";
  loginAlert.innerHTML=`<div class="alert alert-${type} alert-dismissible fade show">${msg}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
}

function updateLoginStatus(){
  if(isLoggedIn){
    loginStatus.textContent="Voc√™ est√° logado.";
    loginLogoutBtn.textContent="Logout";
    loginLogoutBtn.classList.replace("btn-outline-primary","btn-outline-danger");
    addProductBtn.classList.remove("d-none");
    loginLogoutBtn.onclick = ()=>{ signOut(auth).then(()=>{ isLoggedIn=false; currentUserId=null; updateLoginStatus(); loadProducts(); renderCart(); }); };
  } else {
    loginStatus.textContent="Voc√™ n√£o est√° logado.";
    loginLogoutBtn.textContent="Login";
    loginLogoutBtn.classList.replace("btn-outline-danger","btn-outline-primary");
    addProductBtn.classList.add("d-none");
    loginLogoutBtn.onclick = ()=>{ loginModal.show(); };
  }
}

function renderCart(){
  const cartItems = document.getElementById("cartItems");
  cartItems.innerHTML="";
  cart.forEach((p,i)=>{
    const item=document.createElement("div");
    item.className="list-group-item d-flex justify-content-between align-items-center";
    item.innerHTML=`${p.nome} - R$ ${(p.preco||0).toFixed(2)} <button class="btn btn-sm btn-danger">X</button>`;
    item.querySelector("button").onclick=()=>{ cart.splice(i,1); renderCart(); };
    cartItems.appendChild(item);
  });
  const total=cart.reduce((a,b)=>a+(b.preco||0),0);
  document.getElementById("cartTotal").textContent=`R$ ${total.toFixed(2)}`;
  cartBadge.textContent=cart.length;
}

/**
 * Fun√ß√£o para criar o card de produto.
 * @param {object} p - O objeto do produto.
 * @returns {HTMLElement} O elemento de coluna (col) contendo o card.
 */
function createProductCard(p) {
  const col=document.createElement("div"); col.className="col";
  const card=document.createElement("div"); card.className="card h-100 product-card shadow-sm";
  
  // --- L√≥gica da Imagem ou Placeholder ---
  if (p.imagemUrl) {
    const img = document.createElement("img");
    img.src = p.imagemUrl;
    img.className = "card-img-top product-image";
    img.alt = p.nome;
    card.appendChild(img);
  } else {
    // Determine o √≠cone placeholder com base na categoria
    let iconClass = '';
    let placeholderClass = '';
    const categoriasDoProduto = Array.isArray(p.Categoria) ? p.Categoria : (typeof p.Categoria === 'string' ? [p.Categoria] : []);

    if (categoriasDoProduto.includes("Bebida")) {
      iconClass = "bi-cup-fill";
      placeholderClass = "bebida";
    } else if (categoriasDoProduto.includes("Salgadinho")) {
      iconClass = "bi-bag-fill";
      placeholderClass = "salgadinho";
    } else {
        iconClass = "bi-question-circle-fill"; // √çcone gen√©rico se n√£o tiver categoria reconhecida
        placeholderClass = "default";
    }

    const placeholderDiv = document.createElement("div");
    placeholderDiv.className = `product-image-placeholder ${placeholderClass}`;
    const icon = document.createElement("i");
    icon.className = `bi ${iconClass}`;
    placeholderDiv.appendChild(icon);
    card.appendChild(placeholderDiv);
  }
  // --- Fim da L√≥gica da Imagem ou Placeholder ---

  const body=document.createElement("div"); body.className="card-body d-flex flex-column";
  const title=document.createElement("h5"); title.className="card-title"; title.textContent=p.nome;
  const info=document.createElement("div"); info.className="text-muted mb-2"; 
  
  const tamanhosArray = Array.isArray(p.tamanhos) ? p.tamanhos : (typeof p.tamanhos === 'string' ? p.tamanhos.split(',') : ['P','M','G']);
  info.textContent="Tamanhos: "+tamanhosArray.join(",");
  
  const footer=document.createElement("div"); footer.className="mt-auto d-flex flex-column align-items-start";
  const priceSpan=document.createElement("span"); priceSpan.textContent=`R$ ${(p.preco||0).toFixed(2)}`;
  const editDiv=document.createElement("div"); editDiv.className="edit-btn";

  if(isLoggedIn){
    const editBtn=document.createElement("button"); editBtn.className="btn btn-sm btn-primary"; editBtn.textContent="‚úé";
    editBtn.onclick=()=>{
      document.getElementById("productId").value=p.id;
      document.getElementById("productName").value=p.nome;
      document.getElementById("productPrice").value=p.preco;
      
      const categoriasDoProduto = Array.isArray(p.Categoria) ? p.Categoria : (typeof p.Categoria === 'string' ? [p.Categoria] : []);
      Array.from(document.getElementById("productCategory").options).forEach(option => {
        option.selected = categoriasDoProduto.includes(option.value);
      });
      document.getElementById("productSizes").value=tamanhosArray.join(",");
      document.getElementById("productImage").value=p.imagemUrl || ''; // Carrega a URL da imagem
      productModal.show();
    };
    const delBtn=document.createElement("button"); delBtn.className="btn btn-sm btn-danger"; delBtn.textContent="üóë";
    delBtn.onclick=async()=>{
      if(confirm(`Tem certeza que deseja deletar o produto ${p.nome}?`)){
        await deleteDoc(doc(db,"produtos",p.id)); 
        loadProducts();
      }
    };
    editDiv.append(editBtn, delBtn);
    card.appendChild(editDiv);
  } else {
    const addBtn=document.createElement("button");
    addBtn.className="btn btn-success btn-sm mt-2";
    addBtn.textContent="+ Adicionar ao carrinho";
    addBtn.onclick=(e)=>{ e.stopPropagation(); cart.push({nome:p.nome, preco:p.preco}); renderCart(); };
    footer.appendChild(addBtn);
  }

  footer.appendChild(priceSpan);
  body.append(title,info,footer);
  card.appendChild(body);
  col.appendChild(card);
  return col;
}

// --- L√≥gica Principal de Carregamento ---

async function loadProducts(){
  salgadinhosGrid.innerHTML="";
  bebidasGrid.innerHTML="";
  
  try{
    const snapshot = await getDocs(collection(db,"produtos"));
    snapshot.forEach(docSnap=>{
      const p={id:docSnap.id, ...docSnap.data()};
      
      let categorias = Array.isArray(p.Categoria) ? p.Categoria : (typeof p.Categoria === 'string' ? [p.Categoria] : []);
      
      if(categorias.length > 0){
        
        if(categorias.includes("Salgadinho")) {
          salgadinhosGrid.appendChild(createProductCard(p));
        }
        if(categorias.includes("Bebida")) {
          bebidasGrid.appendChild(createProductCard(p));
        }
      }
    });
  } catch(e){ console.error("Erro ao carregar produtos:", e); }
}

// --- Event Listeners ---

document.getElementById("clearCartBtn").addEventListener("click", ()=>{ cart=[]; renderCart(); });

document.getElementById("checkoutBtn").addEventListener("click", ()=>{
  if(cart.length===0){ alert("Carrinho vazio!"); return; }
  let message="Ol√°, quero pedir:\n";
  cart.forEach((p,i)=>{ message+=`${i+1}. ${p.nome} - R$ ${(p.preco||0).toFixed(2)}\n`; });
  const total=cart.reduce((a,b)=>a+(b.preco||0),0);
  message+=`Total: R$ ${total.toFixed(2)}`;
  window.open("https://wa.me/?text="+encodeURIComponent(message),"_blank");
});

cartButton.addEventListener("click", ()=>{ cartOffcanvas.show(); });

addProductBtn.onclick=()=>{ 
  document.getElementById("productForm").reset();
  document.getElementById("productId").value = '';
  Array.from(document.getElementById("productCategory").options).forEach(option => option.selected = false);
  document.getElementById("productSizes").value="P,M,G"; 
  document.getElementById("productImage").value=''; // Limpa o campo de imagem ao adicionar novo
  productModal.show(); 
};

document.getElementById("saveProductBtn").onclick=async()=>{
  const id=document.getElementById("productId").value;
  const nome=document.getElementById("productName").value;
  const preco=parseFloat(document.getElementById("productPrice").value);
  const categorias=Array.from(document.getElementById("productCategory").selectedOptions).map(o=>o.value); 
  const tamanhos=document.getElementById("productSizes").value.split(",").map(t=>t.trim()).filter(t=>t);
  const imagemUrl=document.getElementById("productImage").value.trim(); // Pega a URL da imagem
  
  if(!nome||isNaN(preco)||categorias.length===0){ alert("Preencha todos os campos corretamente"); return; }
  
  try{
    const data = {nome, preco, Categoria:categorias, tamanhos, imagemUrl: imagemUrl || null}; // Salva null se a URL estiver vazia
    if(id){ await updateDoc(doc(db,"produtos",id),data); }
    else{ await addDoc(collection(db,"produtos"),data); }
    productModal.hide();
    loadProducts();
  } catch(e){ alert("Erro ao salvar produto: "+e.message); }
};

loginSubmitBtn.onclick = async () => {
  const mail = loginEmail.value.trim();
  const pass = loginPassword.value.trim();
  if (!mail || !pass) { showLoginAlert("Preencha todos os campos!", "warning"); return; }

  try {
    const userCredential = await signInWithEmailAndPassword(auth, mail, pass);
    // login bem-sucedido
    console.log("Login ok:", userCredential.user);
    loginModal.hide();
    loginEmail.value = '';
    loginPassword.value = '';
    loginAlert.style.display = "none";
  } catch (e) {
    // debug no console
    console.error("Erro no signIn:", e, "code:", e.code, "message:", e.message);

    // mensagens amig√°veis por c√≥digo de erro
    let friendly = "Erro ao tentar entrar. Verifique seu email e senha.";
    if (e.code === "auth/invalid-email") friendly = "Email inv√°lido. Verifique o formato do email.";
    else if (e.code === "auth/user-not-found") friendly = "Conta n√£o encontrada. Verifique o email ou crie uma conta.";
    else if (e.code === "auth/wrong-password") friendly = "Senha incorreta.";
    else if (e.code === "auth/too-many-requests") friendly = "Muitas tentativas. Tente novamente mais tarde.";
    else if (e.code === "auth/network-request-failed") friendly = "Erro de rede. Verifique sua conex√£o.";
    else if (e.code === "auth/operation-not-allowed") friendly = "M√©todo de login n√£o permitido. Ative Email/Password no Firebase.";
    else if (e.code === "auth/invalid" || e.code === "auth/invalid-credential") friendly = "Credenciais inv√°lidas. Verifique a configura√ß√£o do Firebase.";

    showLoginAlert(friendly, "danger");
  }
};

onAuthStateChanged(auth, user => {
  isLoggedIn = !!user;
  currentUserId = user?.uid || null;

  if (isLoggedIn) {
    addProductBtn.classList.remove("d-none");
  } else {
    addProductBtn.classList.add("d-none");
  }

  updateLoginStatus();
  loadProducts();
  renderCart();
});

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>